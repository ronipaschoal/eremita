<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="format-detection" content="telephone=no" />
    <meta name="msapplication-tap-highlight" content="no" />
    <!-- WARNING: for iOS 7, remove the width=device-width and height=device-height attributes. See https://issues.apache.org/jira/browse/CB-4323 -->
    <meta name="viewport" content="user-scalable=no, initial-scale=3, maximum-scale=3, minimum-scale=3, width=device-width, height=device-height, target-densitydpi=device-dpi" />

    <preference name="orientation" value="landscape" />
    <preference name="fullscreen" value="true" />
    
    <link rel="stylesheet" type="text/css" href="css/index.css" />
	<script type="text/javascript" src="cordova.js"></script>
	<script type="text/javascript" src="js/index.js"></script>

	<title>Jogo HTML</title>

	<style>

		body
		{
			font-size: 50px;
			font-weight: bold;
			font-family: Comic Sans MS;
			-webkit-text-stroke: 1px black;
			color: white;
			text-shadow:
			3px 3px 0 #000,
			-1px -1px 0 #000,
			1px -1px 0 #000,
			-1px 1px 0 #000,
			1px 1px 0 #000;
			overflow: hidden;
		}

		div
		{
			position: absolute;
		}

		p
		{
			text-align: center;
		}

		canvas 
		{
			position: absolute;
			top: 0px;
			bottom: 0px;
			left: 0px;
			right: 0px;
			margin: auto;
			z-index: 2;
		}

		html 
		{ 
  			background: url(assets/img/mountains.gif) no-repeat center center fixed; 
			-webkit-background-size: cover;
			-moz-background-size: cover;
			-o-background-size: cover;
			background-size: cover;
		}

		#context
		{
			top: 0px;
			bottom: 0px;
			left: 0px;
			right: 0px;
			width: 1200px;
			height: 600px;
			margin: auto;
		}

		#personagem
		{
			top: 10px;
			left: 50px;
			z-index: 5;
		}
/*
		#iceberg
		{
			top:550px;
			z-index: 1;
		}

		#chao
		{
			background: #9CD0E4;
			z-index: 2;
			top: 600px;
			bottom: 0px;
			left: 0px;
			right: 0px;
			width: 100%;
			height: 300px;
			margin: auto;
		}

*/		#menu_title
		{
			top: 0px;
			bottom: 150px;
			left: 0px;
			right: 0px;
			width: 800px;
			height: 140px;
			margin: auto;
			text-align: center;
		}
		
		#menu
		{
			text-align: center;
			top: 0px;
			bottom: 0px;
			left: 0px;
			right: 0px;
			width: 250px;
			height: 100px;
			margin: auto;
			border: solid 1px #000000;
			cursor: pointer;
		}

		#score
		{
			top: 10px;
			left: 50px;
		}

		#record_panel
		{
			top: 10px;
			right: 50px;
		}

		.hidden
		{
			display: none;
		}

		.play
		{
			background: #99BEE5;
		}

		.lose
		{
			background: #FFADAD;
		}

		.menu_info
		{
			margin-top: 10px;
			width: 250px;
		}


	</style>

</head>
<body>
	<div id="context">
		<div id="test" style="top: 10px; left: 900px;"></div>
		<div id="score" class="hidden"></div>
		<div id="record_panel" class="hidden"></div>
		<div id="menu_title"></div>
		<div id="menu"></div>
		<div id="personagem">
			<img id="personagem_parado" src="assets/img/eremita_parado.png" width="72" height="103">
			<img id="personagem_andando" src="assets/img/eremita_andando.png" width="72" height="100" class="hidden">
			<img id="personagem_pulando" src="assets/img/eremita_pulando.png" width="72" height="100" class="hidden">
		</div>

		<div id="obstaculos" style="clip: rect(0px, 1200px, 550px, 0px);">
			
		</div>

		<div id="iceberg">
			<img id="iceberg1" src="assets/img/iceberg1.gif" width="100" height="321" class="hidden">
			<img id="iceberg2" src="assets/img/iceberg2.gif" width="100" height="215" class="hidden">
			<img id="iceberg3" src="assets/img/iceberg3.gif" width="100" height="273" class="hidden">
		</div>

		<div id="chao"></div>

		<audio controls loop hidden id="musica"><source src="assets/sound/05-mb-stage-theme-2.mp3" type="audio/mpeg"></audio>
		<audio controls hidden id="jump"><source src="assets/sound/mario-jump-sound.mp3" type="audio/mpeg"></audio>
		<audio controls hidden id="die"><source src="assets/sound/player-down.mp3" type="audio/mpeg"></audio>

		<div style="display:none;">
			<img id="personagem_caindo" src="assets/img/marioJump2.png" width="32" height="44">
			<img id="chao_cima" src="assets/img/chao_cima_azul.png" width="32" height="44">
			<img id="chao_borda_esquerda" src="assets/img/chao_borda_esquerda.png" width="32" height="32">
			<img id="chao_borda_direita" src="assets/img/chao_borda_direita.png" width="32" height="32">
			<img id="chao_esquerda" src="assets/img/chao_esquerda.png" width="32" height="32">
			<img id="chao_direita" src="assets/img/chao_direita.png" width="32" height="32">
			<img id="chao_dentro" src="assets/img/chao_dentro_azul.png" width="32" height="32">
		</div>
	</div>
<script>
//document.getElementById('test').innerHTML = this.andando;
		var canvas, ctx, ALTURA, LARGURA, LARGURA_TOTAL, frames = 0, maxJump = 3, velocidade = 20,
		currentState, record, KEY_PRESSED = false;
		score = document.getElementById('score'),
		record_panel = document.getElementById('record_panel'),
		menu_title = document.getElementById('menu_title'),
		menu = document.getElementById('menu'),

		state =
		{
			play: 0,
			playing: 1,
			lose: 2
		},

		sound =
		{
			jump: document.getElementById('jump'), 
			music: document.getElementById('musica'), 
			die: document.getElementById('die'),

			configure: function()
			{
				this.jump.volume = 0.1;
				this.music.volume = 0.3;
				this.die.volume = 0.1;
			},

			reset: function()
			{
				this.jump.pause();
				this.jump.currentTime = 1;

				this.music.pause();
				this.music.currentTime = 1;
				
				this.die.pause();
				this.die.currentTime = 1;
			}
			
		},

		chao = 
		{
			y: 550,
			altura: 50,
			count: 0,

			draw: function()
			{
				if (!this.pronto || currentState == state.playing)
				{
					if(this.count == 50)
					{
						this.count = 0;
					}
					this.count += 5;
					var i = 0;
					while(i < LARGURA_TOTAL + this.count)
					{
						ctx.drawImage(document.getElementById('chao_cima'), i - this.count, this.y);
						ctx.drawImage(document.getElementById('chao_dentro'), i - this.count, this.y + 32);
						
						i += 32;
						this.pronto = true;
					}
				}
			}

		},

		personagem = 
		{
			personagem: document.getElementById('personagem'),
			parado: document.getElementById('personagem_parado'),
			andando: document.getElementById('personagem_andando'),
			pulando: document.getElementById('personagem_pulando'),
			x: 50,
			y: 0,
			altura: 100,
			largura: 55,
			gravidade: 2,/*1.6,*/
			velocidade: 0,
			forcaPulo: 23.6,
			quantJump: 0,
			movimento: false,
			passos_count: 0,
			score: 0,

			update: function()
			{
				this.velocidade += this.gravidade;
				this.y += this.velocidade;
				this.personagem.style.top = this.y + "px";

				if((this.y > chao.y - obstaculos.altura - this.altura) && (currentState != state.lose))
				{
					this.altura = 100;
					this.largura = 55;
					this.y = chao.y - obstaculos.altura - this.altura;
					this.quantJump = 0;
					this.velocidade = 0;
					this.passos_count++;

					if(this.passos_count == 4)
					{
						this.movimento = !this.movimento;
						this.passos_count = 0;
						((currentState == state.playing) && !this.movimento) ? this.changeStatus("andando") : this.changeStatus("parado");					
					}
				}
				
			},

			changeStatus: function(option)
			{
				this.pulando.className = (option == "pulando") ? "" : "hidden";
				this.andando.className = (option == "andando") ? "" : "hidden";
				this.parado.className  = (option == "parado") ? "" : "hidden";
			},

			jump: function()
			{
				if(this.quantJump < maxJump)
				{
					this.largura = 65;
					this.velocidade = - this.forcaPulo;
					this.quantJump++;

					this.changeStatus("pulando");
					
					sound.jump.currentTime = 0;
					sound.jump.play();
				}
			},

			reset: function()
			{
				this.velocidade = 0;
				this.y = 0;

				this.changeStatus("parado");

				if(this.score > record)
				{
					localStorage.setItem("record", this.score);
					record = this.score;
				}

				this.score = 0;
			}

		},

		obstaculos = 
		{
			obstaculos: document.getElementById("obstaculos"),
			_obs: [],
			images: [document.getElementById('iceberg1'), document.getElementById('iceberg2'), document.getElementById('iceberg3')],
			insertTime: 0,
			passou: false,
			altura: 0,

			insert: function()
			{
				this._obs.push({
					x: LARGURA,
					largura: 50,
					altura: 40 + Math.floor(180 * Math.random()),
					image: this.images[Math.floor(3 * Math.random())].cloneNode(),
					insert: true,
				});

				this.insertTime = 20 + Math.floor(21 * Math.random());
			},

			update: function()
			{
				//ctx.clearRect ( 0 , 0 , LARGURA, ALTURA );

				if(this.insertTime == 0)
				{
					this.insert();
				}
				else
				{
					this.insertTime--;
				}

				for (var i = 0, tam = this._obs.length; i < tam; i++)
				{
					var obs = this._obs[i];
					if (obs.insert)
					{
						obs.image.className = "";
						obs.image.style.position = "absolute";
						this.obstaculos.appendChild(obs.image);					
					}

					obs.image.style.left = (obs.x - 30) + "px";
					obs.image.style.top = (chao.y - obs.altura) + "px";

					obs.x -= velocidade;

					/*cima ---- | frente ][ | altura */
					//if (personagem.x < obs.x + obs.largura && personagem.x + personagem.largura >= obs.x && personagem.y + personagem.altura >= chao.y - obs.altura)
					if ((personagem.x < obs.x) && ((personagem.x + personagem.largura) >= obs.x) && ((personagem.y + personagem.altura - 40) >= (chao.y - obs.altura)))
					{
						currentState = state.lose;
					
						personagem.jump();
						sound.reset();
						sound.die.play();
					}
					else if((obs.x <= personagem.x + personagem.largura) && (obs.x + obs.largura >= personagem.x + 1))
					{
						this.altura = obs.altura;
					}
					else if((obs.x < personagem.x) && (!obs.passou))
					{
						personagem.score++;
						obs.passou = true;

						this.altura = 0;
						
					}
					else if(obs.x < -obs.largura - 30)
					{
						this.obstaculos.removeChild(this.obstaculos.firstChild);
						this._obs.splice(i, 1);
						
						tam--;
						i--;
					}
				};

			},
			
			clear: function()
			{
				this._obs = [];
				while (this.obstaculos.hasChildNodes()) {  
					this.obstaculos.removeChild(this.obstaculos.firstChild);
				}
			}

			// draw: function()
			// {
			// 	for (var i = 0, tam = this._obs.length; i < tam; i++) {
			// 		var obs = this._obs[i];
			// 		ctx.drawImage(obs.image, obs.x - 30, chao.y - obs.altura);
			// 	};
			// }
		};

		function click(event)
		{

			if(!KEY_PRESSED)
			{
				if (currentState == state.playing)
				{
					personagem.jump();
				}
				else if (currentState == state.play) 
				{
					currentState = state.playing;
					
					sound.music.play();
					menu.className = "hidden";
				}
				else if (currentState == state.lose)
				{
					currentState = state.play;
					
					sound.reset();
					obstaculos.clear();
					personagem.reset();
				}	
			}
			
			KEY_PRESSED = true;
		}


		function clickSpace(event)
		{
			var keyCode = event.keyCode;
			
			if(keyCode == 32)
			{
				click();
			}
		}

		function clickOut(event)
		{
			KEY_PRESSED = false;
		}

		function main()
		{
			LARGURA_TOTAL = window.innerWidth;
			LARGURA = 1200;
			ALTURA = 600;
	
			canvas = document.createElement("canvas");
			canvas.width = LARGURA;
			canvas.height = ALTURA;
			
			ctx = canvas.getContext("2d");
			
			document.body.appendChild(canvas);

			document.addEventListener("mousedown", click);
			document.addEventListener("mouseup", clickOut);

			document.addEventListener("keydown", clickSpace, false);
			document.addEventListener("keyup", clickOut, false);

			sound.configure();
			
			currentState = state.play;

			record = localStorage.getItem("record");

			if (record == null)
			{
				record = 0;
			}

			run();
		}
		
		function run()
		{
			update();
			draw();

			setTimeout(function()
			{
				window.requestAnimationFrame(run);
			}, 4);
		}
		
		function update()
		{
			frames++;
			personagem.update();

			if(currentState == state.playing)
			{
				obstaculos.update();
			}
		}
		
		function draw()
		{
			score.innerHTML = "<small>Score: </small>" + personagem.score;
			record_panel.innerHTML = "<small>Record: </small>" + record;

			if(currentState == state.play)
			{
				
				frames = 0;
			
				menu_title.innerHTML = "O Eremita Do Iceberg";
				menu_title.className = "";

				menu.innerHTML = "<div class=\"menu_info\">\> Play!</div>";
				menu.className = "play";

			}
			else if (currentState == state.lose)
			{

				score.className = "hidden";
				record_panel.className = "hidden";

				if (personagem.score > record)
				{
					text_record = "Novo Record!";
				}
				else
				{
					text_record = "Record " + record;
				}

				chao.pronto = false;
			
				menu_title.innerHTML = text_record;
				menu_title.className = "";

				menu.innerHTML = "<div class=\"menu_info\">" + personagem.score + "</div>";
				menu.className = "lose";

			}
			else if (currentState == state.playing)
			{
				menu_title.className = "hidden";
				score.className = "";
				record_panel.className = "";

				//obstaculos.draw();
			}

			chao.draw();
		}

		main();
	</script>
</body>
</html>